services:
  icecast:
    image: moul/icecast
    container_name: jaren-nul-icecast
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - ICECAST_SOURCE_PASSWORD=hackme
      - ICECAST_ADMIN_PASSWORD=hackme
      - ICECAST_RELAY_PASSWORD=hackme
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c 'echo > /dev/tcp/localhost/8000' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  mopidy:
    image: wesleydv938/jaren-nul-mopidy:latest
    container_name: jaren-nul-mopidy
    restart: unless-stopped
    ports:
      - "6680:6680"   # Web interface
      - "6600:6600"   # MPD protocol
    volumes:
      - mopidy-local:/var/lib/mopidy/local
    environment:
      - TZ=Europe/Brussels
      - SPOTIFY_CLIENT_ID=${SPOTIFY_CLIENT_ID}
      - SPOTIFY_CLIENT_SECRET=${SPOTIFY_CLIENT_SECRET}
    depends_on:
      icecast:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/config/healthcheck.sh"]
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 30s

  sync-service:
    image: wesleydv938/jaren-nul-sync:latest
    container_name: jaren-nul-sync
    restart: unless-stopped
    environment:
      - MOPIDY_HOST=mopidy
      - MOPIDY_PORT=6680
      - GOOGLE_SHEETS_ID=${GOOGLE_SHEETS_ID}
      - GOOGLE_SHEETS_CREDENTIALS=/credentials/service-account.json
    volumes:
      - ${GOOGLE_SHEETS_CREDENTIALS_PATH:-/dev/null}:/credentials/service-account.json:ro
    depends_on:
      mopidy:
        condition: service_healthy

volumes:
  mopidy-local:
